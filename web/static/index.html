<!--
============================================================================
web/static/index.html
Email Memory Agent - Browser Interface
Design: Warm zen mode. Cream surfaces, sage green accents, earthy warmth.
Palette: Aura-inspired - cream bg + dark sidebar + sage accents.
Fonts: Literata (headings) + DM Sans (body) + JetBrains Mono (data).
Navigation: Collapsible dark sidebar (Home / Chat / Vault / Profile).
Pages: HOME, CHAT, VAULT, PROFILE
============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FAF8F5">
    <title>Memory Vault</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,300;0,7..72,400;0,7..72,500;1,7..72,300;1,7..72,400&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
/* ============================================================================
   DESIGN SYSTEM - CSS Custom Properties
   ============================================================================ */
:root {
    /* Backgrounds */
    --bg-primary: #FAF8F5;
    --bg-secondary: #F3F0EB;
    --bg-chat: #FFFFFF;
    --bg-nav: #36332E;
    --bg-nav-hover: rgba(123, 158, 135, 0.10);
    --bg-nav-active: rgba(123, 158, 135, 0.16);
    --surface-warm: #F0EDE8;
    --surface-assistant: #F7F5F1;

    /* Accent - Sage */
    --accent-sage: #7B9E87;
    --accent-sage-soft: #A8C5B2;
    --accent-sage-deep: #5C8068;
    --accent-sage-glow: rgba(123, 158, 135, 0.15);

    /* Accent - Warm */
    --accent-warm: #C4956A;
    --accent-warm-soft: #D4A97D;

    /* Accent - Blue (commitments) */
    --accent-blue: #5C7AAF;
    --accent-blue-glow: rgba(100, 130, 180, 0.15);

    /* Text */
    --text-primary: #2C2A27;
    --text-secondary: #6B6660;
    --text-tertiary: #9E9891;
    --text-nav: rgba(250, 248, 245, 0.50);
    --text-nav-active: rgba(250, 248, 245, 0.92);
    --text-nav-label: rgba(250, 248, 245, 0.30);
    --text-inverse: #FAF8F5;

    /* Borders */
    --border-soft: rgba(44, 42, 39, 0.06);
    --border-medium: rgba(44, 42, 39, 0.10);
    --border-nav: rgba(250, 248, 245, 0.07);

    /* Shadows */
    --shadow-soft: 0 1px 3px rgba(44, 42, 39, 0.04), 0 1px 2px rgba(44, 42, 39, 0.02);
    --shadow-medium: 0 4px 12px rgba(44, 42, 39, 0.06), 0 2px 4px rgba(44, 42, 39, 0.03);
    --shadow-float: 0 12px 32px rgba(44, 42, 39, 0.10), 0 4px 8px rgba(44, 42, 39, 0.04);

    /* Radius */
    --radius-sm: 12px;
    --radius-md: 18px;
    --radius-lg: 24px;
    --radius-full: 9999px;

    /* Typography */
    --font-serif: 'Literata', Georgia, serif;
    --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

    /* Easing */
    --ease-gentle: cubic-bezier(0.25, 0.46, 0.45, 0.94);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);

    /* Layout dimensions */
    --nav-width-expanded: 220px;
    --nav-width-collapsed: 68px;
    --panel-width: 260px;
}

/* ============================================================================
   RESET + BASE
   ============================================================================ */
*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: var(--font-sans);
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--bg-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

button {
    border: none;
    background: none;
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
}

input, textarea {
    border: none;
    outline: none;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    background: transparent;
}

a {
    color: inherit;
    text-decoration: none;
}

/* ============================================================================
   KEYFRAME ANIMATIONS
   ============================================================================ */
@keyframes navIn {
    from { opacity: 0; transform: translateX(-8px); }
    to   { opacity: 1; transform: translateX(0); }
}

@keyframes contentIn {
    from { opacity: 0; }
    to   { opacity: 1; }
}

@keyframes orbFloat {
    0%   { transform: translate(-50%, -50%) rotate(0deg)   scale(1);    }
    33%  { transform: translate(-50%, -52%) rotate(120deg)  scale(1.02); }
    66%  { transform: translate(-50%, -48%) rotate(240deg)  scale(0.98); }
    100% { transform: translate(-50%, -50%) rotate(360deg)  scale(1);    }
}

@keyframes welcomeIn {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
}

@keyframes breathe {
    0%, 100% { transform: scale(1);    opacity: 1;   }
    50%      { transform: scale(1.15); opacity: 0.75; }
}

@keyframes typingBounce {
    0%, 100% { transform: translateY(0);    }
    50%      { transform: translateY(-5px); }
}

@keyframes messageIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
}

@keyframes pageElementIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* ============================================================================
   APP LAYOUT
   ============================================================================ */
.app {
    display: flex;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
}

/* ============================================================================
   SIDEBAR NAVIGATION
   ============================================================================ */
.app-nav {
    width: var(--nav-width-expanded);
    min-width: var(--nav-width-expanded);
    height: 100vh;
    background: var(--bg-nav);
    display: flex;
    flex-direction: column;
    padding: 16px 10px;
    transition: width 0.35s var(--ease-gentle), min-width 0.35s var(--ease-gentle);
    position: relative;
    z-index: 20;
    animation: navIn 0.5s var(--ease-gentle) both;
    overflow: hidden;
}

.app-nav.collapsed {
    width: var(--nav-width-collapsed);
    min-width: var(--nav-width-collapsed);
}

/* Brand */
.nav-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 6px 20px;
    border-bottom: 1px solid var(--border-nav);
    margin-bottom: 16px;
    white-space: nowrap;
    overflow: hidden;
}

.nav-brand-icon {
    width: 36px;
    height: 36px;
    min-width: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--accent-sage), var(--accent-sage-deep));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-inverse);
    box-shadow: 0 2px 8px rgba(123, 158, 135, 0.30);
}

.nav-brand-icon i {
    font-size: 18px;
}

.nav-brand-text {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 500;
    color: var(--text-nav-active);
    letter-spacing: -0.01em;
    opacity: 1;
    transition: opacity 0.25s var(--ease-gentle);
}

.app-nav.collapsed .nav-brand-text {
    opacity: 0;
    pointer-events: none;
}

/* Section label */
.nav-section-label {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-nav-label);
    padding: 0 12px;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 0.25s var(--ease-gentle);
}

.app-nav.collapsed .nav-section-label {
    opacity: 0;
}

/* Nav items */
.nav-items {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    color: var(--text-nav);
    cursor: pointer;
    transition: all 0.2s var(--ease-gentle);
    white-space: nowrap;
    overflow: hidden;
    position: relative;
}

.nav-item:hover {
    background: var(--bg-nav-hover);
    color: var(--text-nav-active);
}

.nav-item.active {
    background: var(--bg-nav-active);
    color: var(--text-nav-active);
}

.nav-item-icon {
    width: 22px;
    height: 22px;
    min-width: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.nav-item-icon i {
    font-size: 16px;
}

.nav-item-label {
    font-family: var(--font-serif);
    font-size: 13.5px;
    font-weight: 400;
    opacity: 1;
    transition: opacity 0.25s var(--ease-gentle);
}

.app-nav.collapsed .nav-item-label {
    opacity: 0;
    pointer-events: none;
}

/* Nav footer */
.nav-footer {
    border-top: 1px solid var(--border-nav);
    padding-top: 14px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.nav-profile {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    white-space: nowrap;
    border: none;
    background: none;
    cursor: pointer;
    text-align: left;
    font: inherit;
    color: inherit;
    transition: background 0.2s var(--ease-gentle);
}
.nav-profile:hover {
    background: var(--bg-nav-hover);
}

.nav-avatar {
    width: 32px;
    height: 32px;
    min-width: 32px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--accent-sage-soft), var(--accent-sage));
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-sans);
    font-weight: 600;
    font-size: 13px;
    color: var(--text-inverse);
}

.nav-profile-info {
    display: flex;
    flex-direction: column;
    opacity: 1;
    transition: opacity 0.25s var(--ease-gentle);
}

.app-nav.collapsed .nav-profile-info {
    opacity: 0;
    pointer-events: none;
}

.nav-profile-name {
    font-size: 12.5px;
    font-weight: 500;
    color: var(--text-nav-active);
    line-height: 1.3;
}

.nav-profile-sub {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-nav-label);
    line-height: 1.3;
}

/* Collapse toggle */
.nav-collapse-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 8px 0;
    color: var(--text-nav);
    border-radius: var(--radius-sm);
    transition: all 0.2s var(--ease-gentle);
}

.nav-collapse-btn:hover {
    color: var(--text-nav-active);
    background: var(--bg-nav-hover);
}

.nav-collapse-btn i {
    font-size: 14px;
    transition: transform 0.35s var(--ease-gentle);
}

.app-nav.collapsed .nav-collapse-btn i {
    transform: rotate(180deg);
}

/* ============================================================================
   MAIN CONTENT AREA
   ============================================================================ */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: 100vh;
    position: relative;
    background: var(--bg-primary);
    animation: contentIn 0.6s var(--ease-gentle) 0.15s both;
}

/* Subtle noise texture overlay */
.main-content::after {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    opacity: 0.35;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    background-size: 256px 256px;
}

/* ============================================================================
   PAGE VIEWS (generic)
   ============================================================================ */
.page-view {
    display: none;
    flex: 1;
    flex-direction: column;
    padding: 48px 56px;
    overflow-y: auto;
    position: relative;
    z-index: 1;
}

.page-view.active {
    display: flex;
}

.page-view h1 {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 400;
    color: var(--text-primary);
    margin-bottom: 6px;
    animation: pageElementIn 0.5s var(--ease-gentle) both;
}

.page-view .page-subtitle {
    font-size: 14px;
    color: var(--text-tertiary);
    margin-bottom: 32px;
    animation: pageElementIn 0.5s var(--ease-gentle) 0.08s both;
}

.page-view .page-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--text-tertiary);
    font-family: var(--font-serif);
    font-size: 16px;
    font-style: italic;
    animation: pageElementIn 0.5s var(--ease-gentle) 0.16s both;
}

/* ============================================================================
   CHAT VIEW (full layout)
   ============================================================================ */
#chatView {
    flex: 1;
    min-width: 0;
    min-height: 0;
    position: relative;
    z-index: 1;
}

/* ---- Chat Panel (conversations sidebar) ---- */
.chat-panel {
    width: var(--panel-width);
    min-width: var(--panel-width);
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-soft);
    display: flex;
    flex-direction: column;
    transition: width 0.3s var(--ease-gentle), min-width 0.3s var(--ease-gentle), opacity 0.25s var(--ease-gentle);
    overflow: hidden;
}

.chat-panel.hidden {
    width: 0;
    min-width: 0;
    opacity: 0;
    pointer-events: none;
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 18px 14px;
    border-bottom: 1px solid var(--border-soft);
}

.panel-header h2 {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
}

.panel-toggle-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    color: var(--text-tertiary);
    transition: all 0.2s var(--ease-gentle);
}

.panel-toggle-btn:hover {
    background: var(--surface-warm);
    color: var(--text-secondary);
}

.panel-toggle-btn i {
    font-size: 14px;
}

.panel-new-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 14px 14px 8px;
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    background: var(--bg-chat);
    border: 1px solid var(--border-soft);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s var(--ease-gentle);
    white-space: nowrap;
}

.panel-new-btn:hover {
    border-color: var(--border-medium);
    box-shadow: var(--shadow-soft);
    color: var(--text-primary);
}

.panel-new-btn i {
    font-size: 13px;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px 10px;
}

.chat-list-section {
    padding: 10px 6px 4px;
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-tertiary);
}

.chat-list-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.18s var(--ease-gentle);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-list-item:hover {
    background: var(--surface-warm);
}

.chat-list-item.active {
    background: var(--bg-chat);
    box-shadow: var(--shadow-soft);
}

.chat-list-dot {
    width: 7px;
    height: 7px;
    min-width: 7px;
    border-radius: var(--radius-full);
    background: var(--accent-sage-soft);
    opacity: 0.6;
}

.chat-list-item.active .chat-list-dot {
    background: var(--accent-sage);
    opacity: 1;
}

.chat-list-title {
    font-size: 13px;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-list-item.active .chat-list-title {
    color: var(--text-primary);
    font-weight: 500;
}

/* Panel open button (visible when panel hidden) */
.panel-open-btn {
    display: none;
    position: absolute;
    top: 18px;
    left: 12px;
    z-index: 5;
    width: 34px;
    height: 34px;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    background: var(--bg-chat);
    border: 1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);
    color: var(--text-secondary);
    transition: all 0.2s var(--ease-gentle);
}

.panel-open-btn:hover {
    box-shadow: var(--shadow-medium);
    color: var(--text-primary);
}

.panel-open-btn i {
    font-size: 14px;
}

/* ---- Chat Main ---- */
.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    min-height: 0;
    background: var(--bg-chat);
    position: relative;
}

/* Ambient gradients */
.chat-main::before {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    background:
        radial-gradient(ellipse 600px 400px at 10% 0%, var(--accent-sage-glow), transparent),
        radial-gradient(ellipse 500px 350px at 90% 100%, rgba(196, 149, 106, 0.06), transparent);
}

/* Glass header */
.chat-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 24px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border-soft);
    position: relative;
    z-index: 3;
}

.chat-header-avatar {
    width: 38px;
    height: 38px;
    min-width: 38px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--accent-sage), var(--accent-sage-deep));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-inverse);
    position: relative;
}

.chat-header-avatar i {
    font-size: 18px;
}

.chat-header-avatar .presence-dot {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--accent-sage);
    border: 2px solid var(--bg-chat);
    animation: breathe 3s ease-in-out infinite;
}

.chat-header-info h3 {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.3;
}

.chat-header-info p {
    font-size: 12px;
    color: var(--text-tertiary);
    line-height: 1.3;
}

/* Messages area */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 24px 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    position: relative;
    z-index: 1;
    scroll-behavior: smooth;
}

/* Welcome state */
.welcome-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 32px 24px;
    text-align: center;
}

.welcome-orb-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin-bottom: 16px;
    animation: welcomeIn 0.7s var(--ease-gentle) 0.1s both;
}

.welcome-orb {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 80px;
    height: 80px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--accent-sage-soft), var(--accent-sage), var(--accent-sage-deep));
    opacity: 0.18;
    filter: blur(2px);
    animation: orbFloat 6s ease-in-out infinite;
}

.welcome-orb-inner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--accent-sage), var(--accent-sage-deep));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-inverse);
    box-shadow: 0 4px 20px rgba(123, 158, 135, 0.30);
    z-index: 1;
}

.welcome-orb-inner i {
    font-size: 22px;
}

.welcome-heading {
    font-family: var(--font-serif);
    font-size: 24px;
    font-weight: 400;
    color: var(--text-primary);
    animation: welcomeIn 0.7s var(--ease-gentle) 0.2s both;
}

.welcome-sub {
    font-size: 14px;
    color: var(--text-tertiary);
    max-width: 360px;
    line-height: 1.6;
    animation: welcomeIn 0.7s var(--ease-gentle) 0.3s both;
}

.welcome-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 20px;
    max-width: 480px;
    animation: welcomeIn 0.7s var(--ease-gentle) 0.45s both;
}

.suggestion-chip {
    padding: 9px 16px;
    border-radius: var(--radius-full);
    background: var(--surface-warm);
    border: 1px solid var(--border-soft);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.2s var(--ease-gentle);
    white-space: nowrap;
}

.suggestion-chip:hover {
    background: var(--bg-chat);
    border-color: var(--accent-sage-soft);
    color: var(--text-primary);
    box-shadow: var(--shadow-soft);
    transform: translateY(-2px);
}

/* Message groups */
.message-group {
    display: flex;
    gap: 10px;
    max-width: 680px;
    animation: messageIn 0.35s var(--ease-gentle) both;
}

.message-group.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message-group.assistant {
    align-self: flex-start;
}

.msg-avatar {
    width: 30px;
    height: 30px;
    min-width: 30px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--accent-sage-soft), var(--accent-sage));
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-inverse);
    margin-top: 4px;
}

.msg-avatar svg {
    width: 15px;
    height: 15px;
}

.msg-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.msg-bubble {
    padding: 12px 16px;
    border-radius: var(--radius-md);
    font-size: 14px;
    line-height: 1.65;
    word-break: break-word;
    position: relative;
}

.message-group.user .msg-bubble {
    background: linear-gradient(135deg, var(--accent-sage), var(--accent-sage-deep));
    color: var(--text-inverse);
    border-bottom-right-radius: 6px;
    font-family: var(--font-sans);
}

.message-group.assistant .msg-bubble {
    background: var(--surface-assistant);
    color: var(--text-primary);
    border-bottom-left-radius: 6px;
    font-family: var(--font-serif);
    font-size: 14.5px;
    border: 1px solid var(--border-soft);
}

.msg-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 4px;
}

.msg-time {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
}

.msg-copy-btn {
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    color: var(--text-tertiary);
    transition: all 0.18s var(--ease-gentle);
    opacity: 0;
}

.message-group:hover .msg-copy-btn {
    opacity: 1;
}

.msg-copy-btn:hover {
    background: var(--surface-warm);
    color: var(--text-secondary);
}

.msg-copy-btn svg {
    width: 13px;
    height: 13px;
}

.msg-copy-btn.copied {
    color: var(--accent-sage);
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
    animation: messageIn 0.3s var(--ease-gentle) both;
}

.typing-indicator .msg-avatar {
    width: 30px;
    height: 30px;
    min-width: 30px;
}

.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background: var(--surface-assistant);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-soft);
}

.typing-dots span {
    width: 6px;
    height: 6px;
    border-radius: var(--radius-full);
    background: var(--text-tertiary);
    animation: typingBounce 1.2s ease-in-out infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.15s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.3s;
}

/* ---- Input area ---- */
.chat-input-area {
    padding: 12px 24px 18px;
    position: relative;
    z-index: 2;
}

.chat-input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    padding: 10px 14px;
    background: var(--bg-chat);
    border: 1.5px solid var(--border-medium);
    border-radius: var(--radius-md);
    transition: all 0.25s var(--ease-gentle);
    box-shadow: var(--shadow-soft);
}

.chat-input-wrapper:focus-within {
    border-color: var(--accent-sage-soft);
    box-shadow: 0 0 0 3px var(--accent-sage-glow), var(--shadow-soft);
}

.chat-input-wrapper textarea {
    flex: 1;
    resize: none;
    font-size: 14px;
    line-height: 1.55;
    max-height: 140px;
    overflow-y: auto;
    padding: 3px 0;
    color: var(--text-primary);
    background: transparent;
}

.chat-input-wrapper textarea::placeholder {
    color: var(--text-tertiary);
}

.send-btn {
    width: 36px;
    height: 36px;
    min-width: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    background: var(--surface-warm);
    color: var(--text-tertiary);
    transition: all 0.25s var(--ease-spring);
}

.send-btn.active {
    background: linear-gradient(135deg, var(--accent-sage), var(--accent-sage-deep));
    color: var(--text-inverse);
    box-shadow: 0 2px 10px rgba(123, 158, 135, 0.30);
}

.send-btn.active:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 16px rgba(123, 158, 135, 0.40);
}

.send-btn i {
    font-size: 16px;
}

.chat-input-hint {
    text-align: center;
    padding-top: 8px;
    font-size: 11.5px;
    color: var(--text-tertiary);
    font-style: italic;
}

/* ============================================================================
   HOME PAGE - Stats Grid, Page Cards, Quick Actions
   ============================================================================ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 14px;
    margin-bottom: 28px;
    animation: pageElementIn 0.5s var(--ease-gentle) 0.12s both;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-sm);
    padding: 20px;
    transition: all 0.25s var(--ease-gentle);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.stat-value {
    font-family: var(--font-serif);
    font-size: 28px;
    font-weight: 400;
    letter-spacing: -0.02em;
    color: var(--text-primary);
}

.stat-label {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 4px;
}

.page-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-md);
    padding: 24px;
    margin-bottom: 16px;
    transition: all 0.25s var(--ease-gentle);
    animation: pageElementIn 0.5s var(--ease-gentle) 0.16s both;
}

.page-card:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-soft);
}

.page-card h3 {
    font-family: var(--font-serif);
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 12px;
}

.page-card p {
    font-size: 13px;
    color: var(--text-secondary);
}

.card-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--border-soft);
}

.card-row:last-child {
    border-bottom: none;
}

.card-row-label {
    font-size: 13.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-row-value {
    font-size: 13px;
    color: var(--text-tertiary);
}

.empty-state {
    color: var(--text-tertiary);
    font-size: 13px;
    font-style: italic;
}

/* ============================================================================
   VAULT PAGE - Three-Column Tree Navigator (VSCode-style)
   ============================================================================ */
.vault-tree-page {
    padding: 0 !important;
    flex-direction: row !important;
    overflow: hidden !important;
}

.vault-col {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    border-right: 1px solid var(--border-soft);
    animation: contentIn 0.4s var(--ease-gentle) both;
}

.vault-col:last-child {
    border-right: none;
}

/* Column 1: Types */
.vault-col-types {
    width: 200px;
    min-width: 200px;
    background: var(--bg-secondary);
}

/* Column 2: Items list */
.vault-col-items {
    width: 280px;
    min-width: 280px;
    background: var(--bg-primary);
}

/* Column 3: Content */
.vault-col-content {
    flex: 1;
    min-width: 0;
    background: var(--bg-chat);
}

/* Column headers */
.vault-col-header {
    padding: 18px 16px 14px;
    border-bottom: 1px solid var(--border-soft);
    flex-shrink: 0;
}

.vault-col-header h2 {
    font-family: var(--font-serif);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Column scrollable lists */
.vault-col-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px 8px;
}

/* ---- Tree items (column 1) ---- */
.vault-tree-item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.18s var(--ease-gentle);
    text-align: left;
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--text-secondary);
    background: none;
    border: none;
}

.vault-tree-item:hover {
    background: var(--surface-warm);
    color: var(--text-primary);
}

.vault-tree-item.active {
    background: var(--accent-sage-glow);
    color: var(--accent-sage-deep);
    font-weight: 500;
}

.vault-tree-icon {
    width: 18px;
    min-width: 18px;
    font-size: 15px;
    text-align: center;
}

.vault-tree-label {
    flex: 1;
}

.vault-tree-count {
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--text-tertiary);
    min-width: 20px;
    text-align: right;
}

.vault-tree-item.active .vault-tree-count {
    color: var(--accent-sage);
}

/* ---- File items (column 2) ---- */
.vault-file-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.18s var(--ease-gentle);
    text-align: left;
    background: none;
    border: none;
    font-family: var(--font-sans);
}

.vault-file-item:hover {
    background: var(--surface-warm);
}

.vault-file-item.active {
    background: var(--bg-chat);
    box-shadow: var(--shadow-soft);
}

.vault-file-title {
    font-size: 13px;
    font-weight: 400;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.vault-file-item.active .vault-file-title {
    font-weight: 500;
}

.vault-file-date {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
}

.vault-file-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 2px;
}

/* Inline search in column 2 header */
.vault-search-inline {
    position: relative;
    margin-top: 8px;
}

.vault-search-icon-sm {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: var(--text-tertiary);
    pointer-events: none;
}

.vault-search-sm {
    width: 100%;
    padding: 7px 10px 7px 30px;
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--text-primary);
    background: var(--bg-chat);
    transition: all 0.2s var(--ease-gentle);
}

.vault-search-sm:focus {
    border-color: var(--accent-sage-soft);
    box-shadow: 0 0 0 2px var(--accent-sage-glow);
    outline: none;
}

.vault-search-sm::placeholder {
    color: var(--text-tertiary);
}

/* ---- Content viewer (column 3) ---- */
.vault-content-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
    position: relative;
}

.vault-content-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 40px;
}

.vault-content-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.vault-content-meta span {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 3px 8px;
    background: var(--surface-warm);
    border-radius: var(--radius-full);
    color: var(--text-secondary);
}

/* Rendered markdown in column 3 */
.vault-rendered-md {
    line-height: 1.75;
    font-size: 14px;
    color: var(--text-primary);
}

.vault-rendered-md h2 {
    font-family: var(--font-serif);
    font-size: 20px;
    font-weight: 500;
    margin: 20px 0 10px;
    color: var(--text-primary);
}

.vault-rendered-md h3 {
    font-family: var(--font-serif);
    font-size: 16px;
    font-weight: 500;
    margin: 16px 0 8px;
}

.vault-rendered-md h4 {
    font-family: var(--font-serif);
    font-size: 14px;
    font-weight: 500;
    margin: 12px 0 6px;
}

.vault-rendered-md p {
    margin-bottom: 10px;
}

.vault-rendered-md strong {
    font-weight: 600;
}

.vault-rendered-md em {
    font-style: italic;
}

.vault-rendered-md code {
    font-family: var(--font-mono);
    font-size: 12px;
    background: var(--surface-warm);
    padding: 2px 6px;
    border-radius: 4px;
}

.wiki-link {
    color: var(--accent-sage-deep);
    font-weight: 500;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
    text-decoration-color: var(--accent-sage-soft);
}

.tag {
    font-family: var(--font-mono);
    font-size: 10px;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    background: var(--surface-warm);
    color: var(--text-secondary);
}

.type-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: var(--radius-full);
    letter-spacing: 0.05em;
    display: inline-block;
}

.type-badge.decisions {
    background: rgba(123, 158, 135, 0.15);
    color: var(--accent-sage-deep);
}

.type-badge.people {
    background: rgba(196, 149, 106, 0.15);
    color: var(--accent-warm);
}

.type-badge.commitments {
    background: var(--accent-blue-glow);
    color: var(--accent-blue);
}

/* ============================================================================
   PROFILE PAGE - Auth, Build Controls, Progress
   ============================================================================ */
.connect-btn {
    padding: 8px 20px;
    border-radius: var(--radius-full);
    border: 1.5px solid var(--accent-sage);
    background: transparent;
    color: var(--accent-sage-deep);
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s var(--ease-gentle);
}

.connect-btn:hover {
    background: var(--accent-sage);
    color: var(--text-inverse);
}

.connect-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.auth-badge {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 500;
    padding: 4px 12px;
    border-radius: var(--radius-full);
    letter-spacing: 0.03em;
}

.auth-badge.connected {
    background: rgba(123, 158, 135, 0.15);
    color: var(--accent-sage-deep);
}

.auth-badge.disconnected {
    background: rgba(196, 149, 106, 0.15);
    color: var(--accent-warm);
}

.page-card-description {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.55;
}

.build-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.build-field label {
    font-size: 12px;
    color: var(--text-tertiary);
    display: block;
    margin-bottom: 4px;
    font-family: var(--font-sans);
}

.build-field input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border-medium);
    border-radius: var(--radius-sm);
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--text-primary);
    background: var(--bg-chat);
    transition: all 0.25s var(--ease-gentle);
}

.build-field input:focus {
    border-color: var(--accent-sage-soft);
    box-shadow: 0 0 0 3px var(--accent-sage-glow);
    outline: none;
}

.build-field input::placeholder {
    color: var(--text-tertiary);
}

.build-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: var(--radius-full);
    border: none;
    background: var(--accent-sage);
    color: var(--text-inverse);
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s var(--ease-gentle);
}

.build-btn:hover {
    background: var(--accent-sage-deep);
    box-shadow: 0 2px 10px rgba(123, 158, 135, 0.30);
}

.build-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.build-progress {
    margin-top: 20px;
    padding: 16px 20px;
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-soft);
    display: flex;
    align-items: center;
    gap: 12px;
}

.progress-dot {
    width: 10px;
    height: 10px;
    min-width: 10px;
    border-radius: var(--radius-full);
    background: var(--accent-sage);
    animation: buildPulse 1.5s ease-in-out infinite;
}

.build-progress.done .progress-dot {
    animation: none;
}

.build-progress.error .progress-dot {
    animation: none;
    background: var(--accent-warm);
}

.progress-message {
    flex: 1;
    min-width: 0;
    font-size: 13px;
    color: var(--text-secondary);
    font-family: var(--font-sans);
}

.progress-step {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--accent-sage-deep);
    background: var(--accent-sage-glow);
    padding: 3px 9px;
    border-radius: 6px;
    white-space: nowrap;
    letter-spacing: 0.5px;
}
.build-progress.done .progress-step {
    color: var(--accent-sage);
    background: rgba(123, 158, 135, 0.12);
}
.build-progress.error .progress-step {
    color: var(--accent-warm);
    background: rgba(196, 149, 106, 0.12);
}

/* ============================================================================
   RESPONSIVE (< 900px)
   ============================================================================ */
@media (max-width: 900px) {
    .app-nav {
        width: var(--nav-width-collapsed);
        min-width: var(--nav-width-collapsed);
    }

    .app-nav .nav-brand-text,
    .app-nav .nav-item-label,
    .app-nav .nav-section-label,
    .app-nav .nav-profile-info,
    .app-nav .nav-badge {
        opacity: 0;
        pointer-events: none;
    }

    .chat-panel {
        width: 0;
        min-width: 0;
        opacity: 0;
        pointer-events: none;
    }

    .chat-panel.panel-mobile-open {
        width: var(--panel-width);
        min-width: var(--panel-width);
        opacity: 1;
        pointer-events: auto;
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 10;
        box-shadow: var(--shadow-float);
    }

    .panel-open-btn {
        display: flex !important;
    }

    .page-view {
        padding: 32px 24px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .vault-grid {
        grid-template-columns: 1fr;
    }

    .build-controls {
        grid-template-columns: 1fr;
    }

    .memory-detail {
        width: 95%;
        padding: 24px;
        max-height: 90vh;
    }
}

/* ============================================================================
   SCROLLBAR STYLING
   ============================================================================ */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: var(--border-medium);
    border-radius: var(--radius-full);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-tertiary);
}

/* ============================================================================
   UTILITY
   ============================================================================ */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* ============================================================================
   LOGIN PAGE
   ============================================================================ */
.login-page {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-primary);
    transition: opacity 0.5s var(--ease-gentle), visibility 0.5s;
}
.login-page.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}
.login-bg {
    position: absolute;
    inset: 0;
    background:
        radial-gradient(ellipse at 30% 20%, rgba(123,158,135,0.12) 0%, transparent 60%),
        radial-gradient(ellipse at 70% 80%, rgba(196,149,106,0.10) 0%, transparent 50%);
}
.login-grain {
    position: absolute;
    inset: 0;
    opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}
.login-container {
    position: relative;
    text-align: center;
    padding: 48px 40px;
    max-width: 400px;
    animation: loginFadeUp 0.8s var(--ease-gentle) both;
}
@keyframes loginFadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to { opacity: 1; transform: translateY(0); }
}
.login-orb {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-sage) 0%, var(--accent-sage-deep) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 28px;
    box-shadow: 0 8px 32px rgba(123,158,135,0.25), 0 0 0 1px rgba(123,158,135,0.10);
}
.login-orb i {
    font-size: 32px;
    color: var(--text-inverse);
}
.login-title {
    font-family: var(--font-serif);
    font-size: 32px;
    font-weight: 400;
    color: var(--text-primary);
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}
.login-subtitle {
    font-family: var(--font-sans);
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 40px;
    line-height: 1.5;
}
.login-google-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 14px 32px;
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-full);
    background: var(--bg-chat);
    font-family: var(--font-sans);
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.25s var(--ease-gentle);
    box-shadow: var(--shadow-soft);
}
.login-google-btn:hover {
    box-shadow: var(--shadow-medium);
    border-color: var(--accent-sage-soft);
    transform: translateY(-1px);
}
.login-google-btn:active {
    transform: translateY(0);
}
.login-google-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}
.login-google-btn .google-logo {
    flex-shrink: 0;
}
.login-footnote {
    font-family: var(--font-sans);
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 20px;
}

/* ============================================================================
   TOP BAR (logout area)
   ============================================================================ */
.top-bar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 12px 28px 0;
    gap: 12px;
}
.top-bar-right {
    display: flex;
    align-items: center;
    gap: 12px;
}
.top-bar-email {
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--text-tertiary);
}
.logout-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-full);
    background: transparent;
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s var(--ease-gentle);
}
.logout-btn:hover {
    border-color: var(--accent-warm-soft);
    color: var(--accent-warm);
    background: rgba(196,149,106,0.06);
}
.logout-btn i {
    font-size: 13px;
}

/* ============================================================================
   GLOBAL BUILD INDICATOR (sidebar)
   ============================================================================ */
.build-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    margin: 0 12px 8px;
    border-radius: var(--radius-sm);
    background: rgba(123, 158, 135, 0.08);
}
.build-indicator.active {
    display: flex;
}
.build-indicator-dot {
    width: 8px;
    height: 8px;
    min-width: 8px;
    border-radius: var(--radius-full);
    background: var(--accent-sage);
    animation: buildPulse 1.5s ease-in-out infinite;
}
.build-indicator.done .build-indicator-dot {
    animation: none;
    background: var(--accent-sage);
}
.build-indicator.error .build-indicator-dot {
    animation: none;
    background: var(--accent-warm);
}
@keyframes buildPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
}
.build-indicator-text {
    font-family: var(--font-sans);
    font-size: 11px;
    color: var(--text-nav);
    flex: 1;
    min-width: 0;
    line-height: 1.4;
}
.build-indicator-step {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--accent-sage);
    background: rgba(123, 158, 135, 0.18);
    padding: 2px 7px;
    border-radius: 6px;
    white-space: nowrap;
    letter-spacing: 0.5px;
    line-height: 1.4;
}
.build-indicator.done .build-indicator-step {
    color: var(--text-nav-active);
    background: rgba(123, 158, 135, 0.25);
}
.build-indicator.error .build-indicator-step {
    color: var(--accent-warm);
    background: rgba(196, 149, 106, 0.18);
}
.app-nav.collapsed .build-indicator-text,
.app-nav.collapsed .build-indicator-step {
    opacity: 0;
}
.app-nav.collapsed .build-indicator {
    justify-content: center;
    padding: 8px;
    margin: 0 8px 4px;
}

/* ============================================================================
   HOME PAGE BUILD PROGRESS CARD
   ============================================================================ */
.home-build-card {
    display: none;
    padding: 20px 24px;
    background: var(--bg-chat);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-soft);
}
.home-build-card.active {
    display: block;
}
.home-build-status {
    display: flex;
    align-items: center;
    gap: 12px;
}
.home-build-dot {
    width: 10px;
    height: 10px;
    min-width: 10px;
    border-radius: var(--radius-full);
    background: var(--accent-sage);
    animation: buildPulse 1.5s ease-in-out infinite;
}
.home-build-card.done .home-build-dot {
    animation: none;
    background: var(--accent-sage);
}
.home-build-card.error .home-build-dot {
    animation: none;
    background: var(--accent-warm);
}
.home-build-text {
    flex: 1;
    min-width: 0;
}
.home-build-message {
    font-family: var(--font-sans);
    font-size: 14px;
    color: var(--text-primary);
    line-height: 1.4;
}
.home-build-step {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--accent-sage-deep);
    background: var(--accent-sage-glow);
    padding: 3px 9px;
    border-radius: 6px;
    white-space: nowrap;
    letter-spacing: 0.5px;
}
.home-build-card.done .home-build-step {
    color: var(--accent-sage);
    background: rgba(123, 158, 135, 0.12);
}
.home-build-card.error .home-build-step {
    color: var(--accent-warm);
    background: rgba(196, 149, 106, 0.12);
}
    </style>
</head>
<body>

<!-- ================================================================
     LOGIN PAGE (shown when not authenticated)
     ================================================================ -->
<div class="login-page" id="loginPage">
    <div class="login-bg">
        <div class="login-grain"></div>
    </div>
    <div class="login-container">
        <div class="login-brand">
            <div class="login-orb">
                <i class="fa-solid fa-brain" aria-hidden="true"></i>
            </div>
            <h1 class="login-title">Memory Vault</h1>
            <p class="login-subtitle">Your personal AI memory, built from email</p>
        </div>
        <button class="login-google-btn" id="loginGoogleBtn" onclick="loginWithGoogle()">
            <svg class="google-logo" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" fill="#4285F4"/>
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
            </svg>
            Sign in with Google
        </button>
        <p class="login-footnote">Connects to Gmail (read-only) to build your memory vault</p>
    </div>
</div>

<div class="app">
    <!-- ================================================================
         SIDEBAR NAVIGATION
         ================================================================ -->
    <nav class="app-nav" id="appNav" aria-label="Main navigation">
        <!-- Brand -->
        <div class="nav-brand">
            <div class="nav-brand-icon" aria-hidden="true">
                <i class="fa-solid fa-brain"></i>
            </div>
            <span class="nav-brand-text">Memory Vault</span>
        </div>

        <!-- Section label -->
        <div class="nav-section-label">Navigate</div>

        <!-- Nav items -->
        <div class="nav-items">
            <button class="nav-item" data-page="home" onclick="navigateTo('home')" aria-label="Home">
                <span class="nav-item-icon" aria-hidden="true">
                    <i class="fa-solid fa-house"></i>
                </span>
                <span class="nav-item-label">Home</span>
            </button>

            <button class="nav-item active" data-page="chat" onclick="navigateTo('chat')" aria-label="Chat">
                <span class="nav-item-icon" aria-hidden="true">
                    <i class="fa-solid fa-comments"></i>
                </span>
                <span class="nav-item-label">Chat</span>
            </button>

            <button class="nav-item" data-page="vault" onclick="navigateTo('vault')" aria-label="Vault">
                <span class="nav-item-icon" aria-hidden="true">
                    <i class="fa-solid fa-vault"></i>
                </span>
                <span class="nav-item-label">Vault</span>
            </button>
        </div>

        <!-- Global build indicator (above profile) -->
        <div class="build-indicator" id="buildIndicator">
            <span class="build-indicator-dot"></span>
            <span class="build-indicator-text" id="buildIndicatorText">Syncing emails...</span>
            <span class="build-indicator-step" id="buildIndicatorStep"></span>
        </div>

        <!-- Footer -->
        <div class="nav-footer">
            <button class="nav-profile" onclick="navigateTo('profile')" aria-label="Profile">
                <div class="nav-avatar" aria-hidden="true" id="navAvatar">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="nav-profile-info">
                    <div class="nav-profile-name" id="navProfileName">My Profile</div>
                    <div class="nav-profile-sub" id="navProfileSub">local agent</div>
                </div>
            </button>
            <button class="nav-collapse-btn" onclick="toggleNav()" aria-label="Toggle sidebar">
                <i class="fa-solid fa-angles-left" aria-hidden="true"></i>
            </button>
        </div>
    </nav>

    <!-- ================================================================
         MAIN CONTENT
         ================================================================ -->
    <div class="main-content">

        <!-- Top bar with logout -->
        <div class="top-bar" id="topBar">
            <div class="top-bar-right">
                <span class="top-bar-email" id="logoutEmail"></span>
                <button class="logout-btn" onclick="logoutAccount()" aria-label="Logout">
                    <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
                    <span class="logout-label">Logout</span>
                </button>
            </div>
        </div>

        <!-- Page: Home -->
        <div class="page-view" id="page-home">
            <h1>Welcome to Memory Vault</h1>
            <p class="page-subtitle">Here's a snapshot of your memory</p>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">&mdash;</div>
                    <div class="stat-label">Total Memories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPeople">&mdash;</div>
                    <div class="stat-label">People</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDecisions">&mdash;</div>
                    <div class="stat-label">Decisions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCommitments">&mdash;</div>
                    <div class="stat-label">Commitments</div>
                </div>
            </div>

            <!-- Auto-build progress (shown during background email processing) -->
            <div class="home-build-card" id="homeBuildCard">
                <div class="home-build-status">
                    <span class="home-build-dot"></span>
                    <div class="home-build-text">
                        <div class="home-build-message" id="homeBuildMessage">Starting...</div>
                    </div>
                    <span class="home-build-step" id="homeBuildStep"></span>
                </div>
            </div>

            <div class="page-card">
                <h3>Quick Actions</h3>
                <div class="card-row" style="cursor:pointer" onclick="navigateTo('profile')">
                    <span class="card-row-label">Build memory from emails</span>
                    <span class="card-row-value" style="font-family:var(--font-mono)">&rarr;</span>
                </div>
                <div class="card-row" style="cursor:pointer" onclick="navigateTo('chat')">
                    <span class="card-row-label">Ask a question</span>
                    <span class="card-row-value" style="font-family:var(--font-mono)">&rarr;</span>
                </div>
                <div class="card-row" style="cursor:pointer" onclick="navigateTo('vault')">
                    <span class="card-row-label">Browse vault</span>
                    <span class="card-row-value" style="font-family:var(--font-mono)">&rarr;</span>
                </div>
            </div>

            <div class="page-card">
                <h3>Recent Memories</h3>
                <div id="recentMemories">
                    <p class="empty-state">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Page: Vault (three-column tree navigator) -->
        <div class="page-view vault-tree-page" id="page-vault">

            <!-- Column 1: Categories (tree roots) -->
            <div class="vault-col vault-col-types" id="vaultColTypes">
                <div class="vault-col-header">
                    <h2>Vault</h2>
                </div>
                <div class="vault-col-list" id="vaultTypeList">
                    <button class="vault-tree-item" data-type="people" onclick="selectVaultType('people', this)" aria-label="People">
                        <i class="fa-solid fa-users vault-tree-icon" aria-hidden="true"></i>
                        <span class="vault-tree-label">People</span>
                        <span class="vault-tree-count" id="countPeople">&mdash;</span>
                    </button>
                    <button class="vault-tree-item" data-type="commitments" onclick="selectVaultType('commitments', this)" aria-label="Commitments">
                        <i class="fa-solid fa-circle-check vault-tree-icon" aria-hidden="true"></i>
                        <span class="vault-tree-label">Commitments</span>
                        <span class="vault-tree-count" id="countCommitments">&mdash;</span>
                    </button>
                    <button class="vault-tree-item" data-type="decisions" onclick="selectVaultType('decisions', this)" aria-label="Decisions">
                        <i class="fa-solid fa-scale-balanced vault-tree-icon" aria-hidden="true"></i>
                        <span class="vault-tree-label">Decisions</span>
                        <span class="vault-tree-count" id="countDecisions">&mdash;</span>
                    </button>
                </div>
            </div>

            <!-- Column 2: Items list -->
            <div class="vault-col vault-col-items" id="vaultColItems">
                <div class="vault-col-header">
                    <h2 id="vaultItemsTitle">Select a category</h2>
                    <div class="vault-search-inline">
                        <i class="fa-solid fa-magnifying-glass vault-search-icon-sm" aria-hidden="true"></i>
                        <input type="text" class="vault-search-sm" id="vaultSearch" placeholder="Filter..." oninput="debouncedSearch()">
                    </div>
                </div>
                <div class="vault-col-list" id="vaultItemList">
                    <p class="empty-state">Choose a category to browse</p>
                </div>
            </div>

            <!-- Column 3: Content viewer -->
            <div class="vault-col vault-col-content" id="vaultColContent">
                <div class="vault-col-header" id="vaultContentHeader" style="display:none">
                    <h2 id="vaultContentTitle"></h2>
                    <div class="vault-content-meta" id="vaultContentMeta"></div>
                </div>
                <div class="vault-content-body" id="vaultContentBody">
                    <div class="vault-content-empty">
                        <i class="fa-regular fa-file-lines" aria-hidden="true" style="font-size:48px;color:var(--text-tertiary);opacity:0.4;margin-bottom:12px"></i>
                        <p class="empty-state">Select a memory to view its content</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Page: Profile -->
        <div class="page-view" id="page-profile">
            <h1>Profile</h1>
            <p class="page-subtitle">Manage your connections and memory pipeline</p>

            <!-- Gmail Connection -->
            <div class="page-card" id="authCard">
                <h3>Gmail Connection</h3>
                <div class="card-row">
                    <span class="card-row-label">Status</span>
                    <span class="card-row-value" id="authStatus">Checking...</span>
                </div>
                <div class="card-row" id="authActionRow" style="display:none">
                    <span class="card-row-label">Action</span>
                    <button class="connect-btn" id="connectBtn" onclick="connectGmail()">Connect Gmail</button>
                </div>
            </div>

            <!-- Build Memory -->
            <div class="page-card">
                <h3>Build Memory</h3>
                <p class="page-card-description">Scan your Gmail and extract memories into the vault.</p>
                <div class="build-controls">
                    <div class="build-field">
                        <label for="buildDays">Days back</label>
                        <input type="number" id="buildDays" value="180" min="1" max="365">
                    </div>
                    <div class="build-field">
                        <label for="buildMax">Max emails</label>
                        <input type="number" id="buildMax" value="500" min="1" max="500">
                    </div>
                    <div class="build-field" style="grid-column: 1 / -1">
                        <label for="buildQuery">Gmail filter (optional)</label>
                        <input type="text" id="buildQuery" placeholder="e.g. from:boss@company.com">
                    </div>
                </div>
                <button class="build-btn" id="buildBtn" onclick="startBuild()">
                    <i class="fa-solid fa-play" aria-hidden="true" style="font-size:12px"></i>
                    Build Memory
                </button>
                <div class="build-progress" id="buildProgress" style="display:none">
                    <span class="progress-dot"></span>
                    <div class="progress-message" id="progressMessage"></div>
                    <span class="progress-step" id="progressStep"></span>
                </div>
            </div>

            <!-- Vault Stats -->
            <div class="page-card">
                <h3>Vault Summary</h3>
                <div id="profileStats">
                    <p class="empty-state">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Page: Chat (active by default) -->
        <div id="chatView" style="display:flex;flex:1;min-width:0;">

            <!-- Conversations Panel -->
            <div class="chat-panel" id="chatPanel">
                <div class="panel-header">
                    <h2>Conversations</h2>
                    <button class="panel-toggle-btn" onclick="togglePanel()" aria-label="Hide conversations panel">
                        <i class="fa-solid fa-table-columns" aria-hidden="true"></i>
                    </button>
                </div>
                <button class="panel-new-btn" onclick="newConversation()">
                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                    New conversation
                </button>
                <div class="chat-list" id="chatList">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Chat Main -->
            <div class="chat-main">

                <!-- Panel open button (visible when panel hidden) -->
                <button class="panel-open-btn" id="panelOpenBtn" onclick="togglePanel()" aria-label="Show conversations panel">
                    <i class="fa-solid fa-table-columns" aria-hidden="true"></i>
                </button>

                <!-- Glass header -->
                <div class="chat-header">
                    <div class="chat-header-avatar" aria-hidden="true">
                        <i class="fa-solid fa-brain"></i>
                        <span class="presence-dot"></span>
                    </div>
                    <div class="chat-header-info">
                        <h3>Memory Vault</h3>
                        <p>Ask about your memories</p>
                    </div>
                </div>

                <!-- Messages container -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome state -->
                    <div class="welcome-state" id="welcomeState">
                        <div class="welcome-orb-container">
                            <div class="welcome-orb"></div>
                            <div class="welcome-orb-inner">
                                <i class="fa-solid fa-brain" aria-hidden="true"></i>
                            </div>
                        </div>
                        <h2 class="welcome-heading">Your Memory Vault</h2>
                        <p class="welcome-sub">
                            Ask me anything about your memories. I search through your vault
                            of decisions, people, commitments, and more to find answers.
                        </p>
                        <div class="welcome-chips">
                            <button class="suggestion-chip" onclick="sendSuggestion(this)">What decisions have I made?</button>
                            <button class="suggestion-chip" onclick="sendSuggestion(this)">Who do I communicate with?</button>
                            <button class="suggestion-chip" onclick="sendSuggestion(this)">What are my commitments?</button>
                            <button class="suggestion-chip" onclick="sendSuggestion(this)">Summarize my vault</button>
                        </div>
                    </div>
                </div>

                <!-- Input area -->
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <textarea
                            id="messageInput"
                            rows="1"
                            placeholder="Ask about your memories..."
                            oninput="autoResize(this)"
                            onkeydown="handleKey(event)"
                            aria-label="Message input"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send message">
                            <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="chat-input-hint">Answers are synthesized from your memory vault</div>
                </div>
            </div>
        </div>

    </div><!-- /main-content -->
</div><!-- /app -->

<script>
/* ============================================================================
   EMAIL MEMORY AGENT - FRONTEND APPLICATION
   ============================================================================
   Security notes:
   - All user-provided text is escaped via esc() before DOM insertion.
   - esc() uses createTextNode to safely encode HTML entities.
   - formatAssistantText() escapes FIRST, then applies safe formatting.
   - Static SVG icons are hardcoded strings with no user data.
   - Dynamic content rendered via innerHTML is ALWAYS escaped through esc()
     first, which encodes all HTML entities via createTextNode. This is the
     same pattern used throughout the existing codebase (setFormattedContent).
   ============================================================================ */
(function() {
    'use strict';

    //  SVG ICON TEMPLATES (static, no user data) 
    var ICON_BRAIN = [
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"',
        ' stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">',
        '<path d="M12 2a7 7 0 0 1 7 7c0 2.5-1.3 4.8-3 6v2a1 1 0 0 1-1 1H9',
        'a1 1 0 0 1-1-1v-2c-1.7-1.2-3-3.5-3-6a7 7 0 0 1 7-7z"/>',
        '<path d="M9 18h6"/><path d="M10 22h4"/></svg>'
    ].join(' ');

    var ICON_COPY = [
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"',
        ' stroke-width="2" stroke-linecap="round" stroke-linejoin="round">',
        '<rect x="9" y="9" width="13" height="13" rx="2"/>',
        '<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>',
        '</svg>'
    ].join('');

    var ICON_CHECK = [
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"',
        ' stroke-width="2" stroke-linecap="round" stroke-linejoin="round">',
        '<polyline points="20 6 9 17 4 12"/></svg>'
    ].join('');

    //  DOM REFERENCES 
    var messagesContainer = document.getElementById('chatMessages');
    var messageInput      = document.getElementById('messageInput');
    var sendBtn           = document.getElementById('sendBtn');
    var welcomeState      = document.getElementById('welcomeState');
    var chatPanel         = document.getElementById('chatPanel');
    var chatList          = document.getElementById('chatList');
    var appNav            = document.getElementById('appNav');
    var panelOpenBtn      = document.getElementById('panelOpenBtn');

    //  STATE 
    var conversationStarted = false;
    var conversations       = [];
    var currentConversation = null;
    var isQuerying          = false;

    //  STORAGE KEY 
    var STORAGE_KEY      = 'mv_conversations';
    var STORAGE_MSG_KEY  = 'mv_messages_';

    //  UTILITY 

    /**
     * HTML-escape a string to prevent XSS.
     * Uses the browser's built-in text encoding via createTextNode.
     */
    function esc(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    // Expose esc() globally so inline onclick handlers can use it
    window.esc = esc;

    /**
     * Get the current time formatted as HH:MM.
     */
    function getTime() {
        var now = new Date();
        var h = now.getHours().toString().padStart(2, '0');
        var m = now.getMinutes().toString().padStart(2, '0');
        return h + ':' + m;
    }

    /**
     * Set a static SVG icon on an element.
     * Only used with hardcoded icon constants, never with user data.
     */
    function setSafeIcon(element, iconMarkup) {
        var temp = document.createElement('template');
        temp.innerHTML = iconMarkup;
        element.appendChild(temp.content.cloneNode(true));
    }

    /**
     * Apply formatted assistant text to a bubble element.
     * Escapes all user-facing text first, then applies safe formatting.
     */
    function setFormattedContent(bubble, text) {
        var escaped = esc(text);
        escaped = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        escaped = escaped.replace(/\*(.+?)\*/g, '<em>$1</em>');
        escaped = escaped.replace(
            /`(.+?)`/g,
            '<code style="font-family:var(--font-mono);font-size:12px;background:var(--surface-warm);padding:2px 5px;border-radius:4px;">$1</code>'
        );
        escaped = escaped.replace(/\n/g, '<br>');
        var temp = document.createElement('template');
        temp.innerHTML = escaped;
        bubble.appendChild(temp.content.cloneNode(true));
    }

    /**
     * Simple content formatter (basic markdown to HTML).
     * Escapes content first for safety, then applies formatting.
     */
    function formatContent(text) {
        var html = esc(text);
        html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
        html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^# (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        html = html.replace(/\[\[(.+?)\]\]/g, '<span class="wiki-link">$1</span>');
        html = html.replace(/\n\n/g, '</p><p>');
        html = html.replace(/\n/g, '<br>');
        return '<p>' + html + '</p>';
    }

    /**
     * Safely set pre-escaped HTML content on an element.
     * All dynamic values MUST be passed through esc() before being
     * included in the markup string. This helper centralizes the
     * innerHTML assignment pattern used throughout the app.
     */
    function setSafeHTML(element, escapedMarkup) {
        var temp = document.createElement('template');
        temp.innerHTML = escapedMarkup;
        element.textContent = '';
        element.appendChild(temp.content.cloneNode(true));
    }

    //  INITIALIZATION 
    function init() {
        // Auth gate: check authentication before showing main app
        checkLoginStatus();
    }

    async function checkLoginStatus() {
        try {
            var res = await fetch('/api/auth/status');
            var data = await res.json();
            if (data.authenticated) {
                showMainApp();
                loadUserInfo();
            } else {
                showLoginPage();
            }
        } catch (e) {
            showLoginPage();
        }
    }

    function showMainApp() {
        var loginPage = document.getElementById('loginPage');
        if (loginPage) loginPage.classList.add('hidden');
        // Initialize the main app components
        loadConversations();
        renderConversationList();
        messageInput.focus();
        updatePanelOpenBtnVisibility();
        checkAuthStatus();
        // Auto-sync emails in background on every app load
        startIncrementalBuild();
    }

    function showLoginPage() {
        var loginPage = document.getElementById('loginPage');
        if (loginPage) loginPage.classList.remove('hidden');
    }

    async function loadUserInfo() {
        try {
            var res = await fetch('/api/auth/user-info');
            if (!res.ok) return;
            var data = await res.json();
            var email = data.email || 'Connected';
            var username = email.split('@')[0];
            // Update sidebar footer
            var profileName = document.getElementById('navProfileName');
            var profileSub = document.getElementById('navProfileSub');
            var avatar = document.getElementById('navAvatar');
            if (profileName) profileName.textContent = username;
            if (profileSub) profileSub.textContent = email;
            if (avatar && username) {
                avatar.textContent = username.charAt(0).toUpperCase();
            }
            // Update logout header email
            var logoutEmail = document.getElementById('logoutEmail');
            if (logoutEmail) logoutEmail.textContent = email;
        } catch (e) { /* silent */ }
    }

    function startIncrementalBuild() {
        // Auto-process newest emails in background, skipping already-processed
        var url = '/api/stream/build?days_back=180&max_emails=500&gmail_query=';
        var source = new EventSource(url);

        //  UI elements 
        var indicator = document.getElementById('buildIndicator');
        var indicatorText = document.getElementById('buildIndicatorText');
        var indicatorStep = document.getElementById('buildIndicatorStep');
        var homeCard = document.getElementById('homeBuildCard');
        var homeMsg = document.getElementById('homeBuildMessage');
        var homeStep = document.getElementById('homeBuildStep');

        // Show both indicators
        if (indicator) indicator.classList.add('active');
        if (homeCard) homeCard.classList.add('active');

        // Track stages for step ratio
        var stageOrder = ['fetching', 'email_reader', 'memory_writer'];
        var totalSteps = stageOrder.length;
        var currentStepNum = 0;

        function updateStepRatio(stageKey, status) {
            var stageIdx = stageOrder.indexOf(stageKey);
            if (stageIdx >= 0) {
                currentStepNum = status === 'complete' ? stageIdx + 1 : stageIdx + 1;
            }
            var ratio = currentStepNum + '/' + totalSteps;
            if (indicatorStep) indicatorStep.textContent = ratio;
            if (homeStep) homeStep.textContent = ratio;
        }

        source.onmessage = function(e) {
            var event = JSON.parse(e.data);
            var msg = event.message || event.stage || '';

            // Update text
            if (indicatorText) indicatorText.textContent = msg;
            if (homeMsg) homeMsg.textContent = msg;

            // Update step ratio
            if (event.stage && event.stage !== 'complete' && event.stage !== 'error') {
                updateStepRatio(event.stage, event.status);
            }

            if (event.stage === 'complete') {
                source.close();
                if (indicator) indicator.classList.add('done');
                if (indicatorText) indicatorText.textContent = 'Sync complete';
                if (indicatorStep) indicatorStep.textContent = totalSteps + '/' + totalSteps;
                if (homeCard) homeCard.classList.add('done');
                if (homeMsg) homeMsg.textContent = event.message || 'Done!';
                if (homeStep) homeStep.textContent = totalSteps + '/' + totalSteps;
                loadHomeData();
                setTimeout(function() {
                    if (indicator) indicator.classList.remove('active');
                }, 5000);
            }

            if (event.stage === 'error') {
                source.close();
                if (indicator) indicator.classList.add('error');
                if (indicatorText) indicatorText.textContent = 'Sync failed';
                if (homeCard) homeCard.classList.add('error');
                if (homeMsg) {
                    homeMsg.textContent = event.message || 'Error during sync';
                    homeMsg.style.color = 'var(--accent-warm)';
                }
                setTimeout(function() {
                    if (indicator) indicator.classList.remove('active');
                }, 8000);
            }
        };

        source.onerror = function() {
            source.close();
            if (indicator) { indicator.classList.add('error'); indicator.classList.remove('active'); }
            if (homeMsg) {
                homeMsg.textContent = 'Connection lost. Check server logs.';
                homeMsg.style.color = 'var(--accent-warm)';
            }
        };
    }

    //  NAVIGATION 

    window.navigateTo = function(page) {
        var pages = document.querySelectorAll('.page-view');
        for (var i = 0; i < pages.length; i++) {
            pages[i].classList.remove('active');
        }

        var chatView = document.getElementById('chatView');
        chatView.style.display = 'none';

        if (page === 'chat') {
            chatView.style.display = 'flex';
        } else {
            var targetPage = document.getElementById('page-' + page);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        var navItems = document.querySelectorAll('.nav-item');
        for (var j = 0; j < navItems.length; j++) {
            navItems[j].classList.remove('active');
            if (navItems[j].getAttribute('data-page') === page) {
                navItems[j].classList.add('active');
            }
        }

        // Load page-specific data
        if (page === 'home') {
            loadHomeData();
        } else if (page === 'vault') {
            loadVaultData();
        } else if (page === 'profile') {
            checkAuthStatus();
            loadProfileStats();
        }
    };

    window.toggleNav = function() {
        appNav.classList.toggle('collapsed');
    };

    window.togglePanel = function() {
        var isMobile = window.innerWidth <= 900;
        if (isMobile) {
            chatPanel.classList.toggle('panel-mobile-open');
        } else {
            chatPanel.classList.toggle('hidden');
        }
        updatePanelOpenBtnVisibility();
    };

    function updatePanelOpenBtnVisibility() {
        var isMobile = window.innerWidth <= 900;
        var isHidden = chatPanel.classList.contains('hidden');
        var isMobileOpen = chatPanel.classList.contains('panel-mobile-open');
        if (isMobile) {
            panelOpenBtn.style.display = isMobileOpen ? 'none' : 'flex';
        } else {
            panelOpenBtn.style.display = isHidden ? 'flex' : 'none';
        }
    }

    //  CHAT FUNCTIONS 

    window.sendMessage = function() {
        var text = messageInput.value.trim();
        if (!text || isQuerying) return;

        if (!conversationStarted) {
            welcomeState.style.display = 'none';
            conversationStarted = true;
        }

        if (!currentConversation) {
            createConversation(text);
        }

        addUserMessage(text);
        saveCurrentMessages();

        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.classList.remove('active');

        isQuerying = true;
        showTyping();

        queryVault(text)
            .then(function(answer) {
                hideTyping();
                addAssistantMessage(answer);
                saveCurrentMessages();
                isQuerying = false;
            })
            .catch(function(err) {
                hideTyping();
                addAssistantMessage('Sorry, something went wrong. Please try again.');
                saveCurrentMessages();
                isQuerying = false;
                console.error('Query error:', err);
            });
    };

    async function queryVault(question) {
        var res = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: question })
        });

        if (!res.ok) {
            var errData;
            try { errData = await res.json(); } catch(e) { errData = {}; }
            throw new Error(errData.detail || 'Query failed with status ' + res.status);
        }

        var data = await res.json();
        return data.answer;
    }

    function addUserMessage(text) {
        var group = document.createElement('div');
        group.className = 'message-group user';

        var content = document.createElement('div');
        content.className = 'msg-content';

        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = text;

        var meta = document.createElement('div');
        meta.className = 'msg-meta';
        meta.style.justifyContent = 'flex-end';

        var time = document.createElement('span');
        time.className = 'msg-time';
        time.textContent = getTime();

        meta.appendChild(time);
        content.appendChild(bubble);
        content.appendChild(meta);
        group.appendChild(content);

        messagesContainer.appendChild(group);
        scrollBottom();
    }

    function addAssistantMessage(text) {
        var group = document.createElement('div');
        group.className = 'message-group assistant';

        var avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.setAttribute('aria-hidden', 'true');
        setSafeIcon(avatar, ICON_BRAIN);

        var content = document.createElement('div');
        content.className = 'msg-content';

        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.setAttribute('data-raw', text);
        setFormattedContent(bubble, text);

        var meta = document.createElement('div');
        meta.className = 'msg-meta';

        var time = document.createElement('span');
        time.className = 'msg-time';
        time.textContent = getTime();

        var copyBtn = document.createElement('button');
        copyBtn.className = 'msg-copy-btn';
        copyBtn.setAttribute('aria-label', 'Copy message');
        copyBtn.onclick = function() { copyMessage(copyBtn); };
        setSafeIcon(copyBtn, ICON_COPY);

        meta.appendChild(time);
        meta.appendChild(copyBtn);
        content.appendChild(bubble);
        content.appendChild(meta);
        group.appendChild(avatar);
        group.appendChild(content);

        messagesContainer.appendChild(group);
        scrollBottom();
    }

    function showTyping() {
        hideTyping();
        var indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typingIndicator';

        var avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.setAttribute('aria-hidden', 'true');
        setSafeIcon(avatar, ICON_BRAIN);

        var dots = document.createElement('div');
        dots.className = 'typing-dots';
        for (var i = 0; i < 3; i++) {
            dots.appendChild(document.createElement('span'));
        }

        indicator.appendChild(avatar);
        indicator.appendChild(dots);
        messagesContainer.appendChild(indicator);
        scrollBottom();
    }

    function hideTyping() {
        var existing = document.getElementById('typingIndicator');
        if (existing) existing.remove();
    }

    window.sendSuggestion = function(chip) {
        var text = chip.textContent;
        messageInput.value = text;
        autoResize(messageInput);
        sendMessage();
    };

    window.autoResize = function(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 140) + 'px';
        if (el.value.trim().length > 0) {
            sendBtn.classList.add('active');
        } else {
            sendBtn.classList.remove('active');
        }
    };

    window.handleKey = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    function scrollBottom() {
        requestAnimationFrame(function() {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        });
    }

    window.copyMessage = function(btn) {
        var bubble = btn.closest('.msg-content').querySelector('.msg-bubble');
        if (!bubble) return;

        var text = bubble.textContent || bubble.innerText;
        navigator.clipboard.writeText(text).then(function() {
            btn.classList.add('copied');
            while (btn.firstChild) btn.removeChild(btn.firstChild);
            setSafeIcon(btn, ICON_CHECK);

            setTimeout(function() {
                btn.classList.remove('copied');
                while (btn.firstChild) btn.removeChild(btn.firstChild);
                setSafeIcon(btn, ICON_COPY);
            }, 1500);
        }).catch(function(err) {
            console.error('Copy failed:', err);
        });
    };

    //  CONVERSATION MANAGEMENT 

    function generateId() {
        return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    }

    function createConversation(firstMessage) {
        var title = firstMessage.length > 40
            ? firstMessage.substring(0, 40) + '...'
            : firstMessage;

        var conv = {
            id: generateId(),
            title: title,
            createdAt: Date.now(),
            updatedAt: Date.now()
        };

        conversations.unshift(conv);
        currentConversation = conv;
        saveConversations();
        renderConversationList();
    }

    window.newConversation = function() {
        currentConversation = null;
        conversationStarted = false;

        var children = messagesContainer.children;
        var toRemove = [];
        for (var i = 0; i < children.length; i++) {
            if (children[i].id !== 'welcomeState') {
                toRemove.push(children[i]);
            }
        }
        for (var j = 0; j < toRemove.length; j++) {
            toRemove[j].remove();
        }

        welcomeState.style.display = '';

        var items = chatList.querySelectorAll('.chat-list-item');
        for (var k = 0; k < items.length; k++) {
            items[k].classList.remove('active');
        }

        messageInput.value = '';
        messageInput.style.height = 'auto';
        sendBtn.classList.remove('active');
        messageInput.focus();
    };

    function loadConversation(convId) {
        var conv = conversations.find(function(c) { return c.id === convId; });
        if (!conv) return;

        currentConversation = conv;
        conversationStarted = true;

        var children = messagesContainer.children;
        var toRemove = [];
        for (var i = 0; i < children.length; i++) {
            if (children[i].id !== 'welcomeState') {
                toRemove.push(children[i]);
            }
        }
        for (var j = 0; j < toRemove.length; j++) {
            toRemove[j].remove();
        }

        welcomeState.style.display = 'none';

        var messages = getStoredMessages(convId);
        for (var m = 0; m < messages.length; m++) {
            var msg = messages[m];
            if (msg.role === 'user') {
                addUserMessageSilent(msg.text, msg.time);
            } else {
                addAssistantMessageSilent(msg.text, msg.time);
            }
        }

        var items = chatList.querySelectorAll('.chat-list-item');
        for (var k = 0; k < items.length; k++) {
            items[k].classList.remove('active');
            if (items[k].getAttribute('data-conv-id') === convId) {
                items[k].classList.add('active');
            }
        }

        scrollBottom();
    }

    function addUserMessageSilent(text, timeStr) {
        var group = document.createElement('div');
        group.className = 'message-group user';
        group.style.animation = 'none';

        var content = document.createElement('div');
        content.className = 'msg-content';

        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = text;

        var meta = document.createElement('div');
        meta.className = 'msg-meta';
        meta.style.justifyContent = 'flex-end';

        var time = document.createElement('span');
        time.className = 'msg-time';
        time.textContent = timeStr || '';

        meta.appendChild(time);
        content.appendChild(bubble);
        content.appendChild(meta);
        group.appendChild(content);
        messagesContainer.appendChild(group);
    }

    function addAssistantMessageSilent(text, timeStr) {
        var group = document.createElement('div');
        group.className = 'message-group assistant';
        group.style.animation = 'none';

        var avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        avatar.setAttribute('aria-hidden', 'true');
        setSafeIcon(avatar, ICON_BRAIN);

        var content = document.createElement('div');
        content.className = 'msg-content';

        var bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        setFormattedContent(bubble, text);

        var meta = document.createElement('div');
        meta.className = 'msg-meta';

        var time = document.createElement('span');
        time.className = 'msg-time';
        time.textContent = timeStr || '';

        var copyBtn = document.createElement('button');
        copyBtn.className = 'msg-copy-btn';
        copyBtn.setAttribute('aria-label', 'Copy message');
        copyBtn.onclick = function() { copyMessage(copyBtn); };
        setSafeIcon(copyBtn, ICON_COPY);

        meta.appendChild(time);
        meta.appendChild(copyBtn);
        content.appendChild(bubble);
        content.appendChild(meta);
        group.appendChild(avatar);
        group.appendChild(content);
        messagesContainer.appendChild(group);
    }

    //  SESSION STORAGE HELPERS 

    function saveConversations() {
        try {
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
        } catch (e) {
            console.warn('Could not save conversations:', e);
        }
    }

    function loadConversations() {
        try {
            var stored = sessionStorage.getItem(STORAGE_KEY);
            if (stored) {
                conversations = JSON.parse(stored);
            }
        } catch (e) {
            conversations = [];
        }
    }

    function saveCurrentMessages() {
        if (!currentConversation) return;

        var messages = [];
        var groups = messagesContainer.querySelectorAll('.message-group');

        for (var i = 0; i < groups.length; i++) {
            var grp = groups[i];
            var bubble = grp.querySelector('.msg-bubble');
            var timeEl = grp.querySelector('.msg-time');
            if (!bubble) continue;

            var role = grp.classList.contains('user') ? 'user' : 'assistant';
            var msgText = (role === 'assistant' && bubble.getAttribute('data-raw'))
                ? bubble.getAttribute('data-raw')
                : (bubble.textContent || bubble.innerText);
            messages.push({
                role: role,
                text: msgText,
                time: timeEl ? timeEl.textContent : ''
            });
        }

        try {
            sessionStorage.setItem(STORAGE_MSG_KEY + currentConversation.id, JSON.stringify(messages));
        } catch (e) {
            console.warn('Could not save messages:', e);
        }

        currentConversation.updatedAt = Date.now();
        saveConversations();
    }

    function getStoredMessages(convId) {
        try {
            var stored = sessionStorage.getItem(STORAGE_MSG_KEY + convId);
            if (stored) return JSON.parse(stored);
        } catch (e) {
            // ignore parse errors
        }
        return [];
    }

    function renderConversationList() {
        while (chatList.firstChild) {
            chatList.removeChild(chatList.firstChild);
        }

        if (conversations.length === 0) return;

        var todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        var todayMs = todayStart.getTime();

        var todayConvs = [];
        var earlierConvs = [];

        for (var i = 0; i < conversations.length; i++) {
            if (conversations[i].createdAt >= todayMs) {
                todayConvs.push(conversations[i]);
            } else {
                earlierConvs.push(conversations[i]);
            }
        }

        if (todayConvs.length > 0) {
            var todayLabel = document.createElement('div');
            todayLabel.className = 'chat-list-section';
            todayLabel.textContent = 'Today';
            chatList.appendChild(todayLabel);

            for (var t = 0; t < todayConvs.length; t++) {
                chatList.appendChild(createConversationItem(todayConvs[t]));
            }
        }

        if (earlierConvs.length > 0) {
            var earlierLabel = document.createElement('div');
            earlierLabel.className = 'chat-list-section';
            earlierLabel.textContent = 'Earlier';
            chatList.appendChild(earlierLabel);

            for (var e = 0; e < earlierConvs.length; e++) {
                chatList.appendChild(createConversationItem(earlierConvs[e]));
            }
        }
    }

    function createConversationItem(conv) {
        var item = document.createElement('div');
        item.className = 'chat-list-item';
        item.setAttribute('data-conv-id', conv.id);

        if (currentConversation && currentConversation.id === conv.id) {
            item.classList.add('active');
        }

        var dot = document.createElement('div');
        dot.className = 'chat-list-dot';

        var title = document.createElement('span');
        title.className = 'chat-list-title';
        title.textContent = conv.title;

        item.appendChild(dot);
        item.appendChild(title);

        item.addEventListener('click', function() {
            loadConversation(conv.id);
        });

        return item;
    }

    //  HOME PAGE 

    async function loadHomeData() {
        try {
            var statsRes = await fetch('/api/stats');
            var stats = await statsRes.json();
            document.getElementById('statTotal').textContent = stats.total || 0;
            document.getElementById('statPeople').textContent = (stats.by_type && stats.by_type.people) || 0;
            document.getElementById('statDecisions').textContent = (stats.by_type && stats.by_type.decisions) || 0;
            document.getElementById('statCommitments').textContent = (stats.by_type && stats.by_type.commitments) || 0;
        } catch (e) {
            console.error('Failed to load stats:', e);
        }

        try {
            var memRes = await fetch('/api/memories');
            var memData = await memRes.json();
            var recent = memData.memories.slice(0, 5);
            var container = document.getElementById('recentMemories');

            if (recent.length === 0) {
                container.textContent = '';
                var emptyP = document.createElement('p');
                emptyP.className = 'empty-state';
                emptyP.textContent = 'No memories yet. Build your vault from the Profile page.';
                container.appendChild(emptyP);
                return;
            }

            // Build recent memories using DOM methods for safety
            container.textContent = '';
            recent.forEach(function(m) {
                var row = document.createElement('div');
                row.className = 'card-row';
                row.style.cursor = 'pointer';
                row.onclick = function() { navigateTo('vault'); };

                var label = document.createElement('span');
                label.className = 'card-row-label';

                var badge = document.createElement('span');
                badge.className = 'type-badge ' + (m.type || '');
                badge.textContent = m.type || '';

                var titleText = document.createTextNode(' ' + (m.title || ''));

                label.appendChild(badge);
                label.appendChild(titleText);

                var value = document.createElement('span');
                value.className = 'card-row-value';
                value.textContent = m.date || '';

                row.appendChild(label);
                row.appendChild(value);
                container.appendChild(row);
            });
        } catch (e) {
            var container2 = document.getElementById('recentMemories');
            container2.textContent = '';
            var errP = document.createElement('p');
            errP.className = 'empty-state';
            errP.textContent = 'Could not load memories.';
            container2.appendChild(errP);
        }
    }

    //  VAULT PAGE (Three-Column Tree Navigator) 

    var vaultDebounceTimer = null;
    var vaultSelectedType = null;
    var vaultSelectedFile = null;
    var vaultAllMemories = [];

    async function loadVaultData() {
        try {
            var res = await fetch('/api/memories');
            var data = await res.json();
            vaultAllMemories = data.memories || [];
            updateVaultCounts();
            // If a type was already selected, refresh its items
            if (vaultSelectedType) {
                renderVaultItems(vaultSelectedType);
            }
        } catch (e) {
            vaultAllMemories = [];
            updateVaultCounts();
        }
    }

    function updateVaultCounts() {
        var counts = { people: 0, decisions: 0, commitments: 0 };
        for (var i = 0; i < vaultAllMemories.length; i++) {
            var t = vaultAllMemories[i].type;
            if (counts[t] !== undefined) counts[t]++;
        }
        var el;
        el = document.getElementById('countPeople');
        if (el) el.textContent = counts.people;
        el = document.getElementById('countDecisions');
        if (el) el.textContent = counts.decisions;
        el = document.getElementById('countCommitments');
        if (el) el.textContent = counts.commitments;
    }

    window.selectVaultType = function(type, btn) {
        vaultSelectedType = type;
        vaultSelectedFile = null;

        // Update active state on type buttons
        var items = document.querySelectorAll('.vault-tree-item');
        for (var i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
        }
        if (btn) btn.classList.add('active');

        // Update column 2 header
        var titleEl = document.getElementById('vaultItemsTitle');
        if (titleEl) titleEl.textContent = type.charAt(0).toUpperCase() + type.slice(1);

        // Clear search
        var searchEl = document.getElementById('vaultSearch');
        if (searchEl) searchEl.value = '';

        // Render items
        renderVaultItems(type);

        // Clear column 3
        clearVaultContent();
    };

    function renderVaultItems(type, filterQuery) {
        var list = document.getElementById('vaultItemList');
        if (!list) return;
        list.textContent = '';

        var filtered = vaultAllMemories.filter(function(m) {
            return m.type === type;
        });

        if (filterQuery) {
            var q = filterQuery.toLowerCase();
            filtered = filtered.filter(function(m) {
                return (m.title && m.title.toLowerCase().indexOf(q) !== -1) ||
                       (m.tags && m.tags.join(' ').toLowerCase().indexOf(q) !== -1);
            });
        }

        if (filtered.length === 0) {
            var emptyP = document.createElement('p');
            emptyP.className = 'empty-state';
            emptyP.textContent = filterQuery ? 'No matches found.' : 'No memories found. Build your vault from the Profile page.';
            list.appendChild(emptyP);
            return;
        }

        filtered.forEach(function(m) {
            var filepath = m.filepath || '';
            var memType = m.type || type;
            var filename = filepath.replace(/\\/g, '/').split('/').pop() || '';

            var item = document.createElement('button');
            item.className = 'vault-file-item';
            item.setAttribute('data-filepath', memType + '/' + filename);

            var title = document.createElement('span');
            title.className = 'vault-file-title';
            title.textContent = m.title || filename;
            item.appendChild(title);

            if (m.date) {
                var date = document.createElement('span');
                date.className = 'vault-file-date';
                date.textContent = m.date;
                item.appendChild(date);
            }

            if (m.tags && m.tags.length > 0) {
                var tagsDiv = document.createElement('div');
                tagsDiv.className = 'vault-file-tags';
                m.tags.forEach(function(t) {
                    var tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = t;
                    tagsDiv.appendChild(tagSpan);
                });
                item.appendChild(tagsDiv);
            }

            item.onclick = function() { selectVaultFile(memType, filename, item); };
            list.appendChild(item);
        });
    }

    function selectVaultFile(type, filename, btn) {
        vaultSelectedFile = { type: type, filename: filename };

        // Update active state on file items
        var items = document.querySelectorAll('.vault-file-item');
        for (var i = 0; i < items.length; i++) {
            items[i].classList.remove('active');
        }
        if (btn) btn.classList.add('active');

        // Load content into column 3
        loadVaultContent(type, filename);
    }

    async function loadVaultContent(type, filename) {
        var body = document.getElementById('vaultContentBody');
        var header = document.getElementById('vaultContentHeader');
        var titleEl = document.getElementById('vaultContentTitle');
        var metaEl = document.getElementById('vaultContentMeta');

        body.textContent = '';
        var loadingP = document.createElement('p');
        loadingP.className = 'empty-state';
        loadingP.textContent = 'Loading...';
        body.appendChild(loadingP);
        header.style.display = 'block';
        titleEl.textContent = '';
        metaEl.textContent = '';

        try {
            var res = await fetch('/api/memory/' + encodeURIComponent(type) + '/' + encodeURIComponent(filename));
            var data = await res.json();
            var fm = data.frontmatter || {};
            var title = fm.title || fm.name || filename;

            // Set title
            titleEl.textContent = title;

            // Build meta badges
            metaEl.textContent = '';
            var metaEntries = [];
            if (fm.date) metaEntries.push('Date: ' + fm.date);
            if (fm.priority) metaEntries.push('Priority: ' + fm.priority);
            if (fm.tags && fm.tags.length) metaEntries.push('Tags: ' + fm.tags.join(', '));
            if (fm.role) metaEntries.push('Role: ' + fm.role);
            if (fm.organization) metaEntries.push('Org: ' + fm.organization);
            if (fm.email) metaEntries.push('Email: ' + fm.email);
            metaEntries.forEach(function(entry) {
                var span = document.createElement('span');
                span.textContent = entry;
                metaEl.appendChild(span);
            });

            // Render markdown content
            body.textContent = '';
            var mdDiv = document.createElement('div');
            mdDiv.className = 'vault-rendered-md';
            setSafeHTML(mdDiv, formatContent(data.content || ''));
            body.appendChild(mdDiv);
        } catch (e) {
            body.textContent = '';
            var errP = document.createElement('p');
            errP.className = 'empty-state';
            errP.textContent = 'Could not load memory.';
            body.appendChild(errP);
        }
    }

    function clearVaultContent() {
        var header = document.getElementById('vaultContentHeader');
        var body = document.getElementById('vaultContentBody');
        if (header) header.style.display = 'none';
        if (body) {
            body.textContent = '';
            var emptyDiv = document.createElement('div');
            emptyDiv.className = 'vault-content-empty';
            var icon = document.createElement('i');
            icon.className = 'fa-regular fa-file-lines';
            icon.setAttribute('aria-hidden', 'true');
            icon.style.cssText = 'font-size:48px;color:var(--text-tertiary);opacity:0.4;margin-bottom:12px';
            emptyDiv.appendChild(icon);
            var p = document.createElement('p');
            p.className = 'empty-state';
            p.textContent = 'Select a memory to view its content';
            emptyDiv.appendChild(p);
            body.appendChild(emptyDiv);
        }
    }

    // Keep openMemoryDetail and closeMemoryDetail for backward compatibility (home page links)
    window.openMemoryDetail = function(type, filename) {
        navigateTo('vault');
        // Select the type first
        var typeBtn = document.querySelector('.vault-tree-item[data-type="' + type + '"]');
        selectVaultType(type, typeBtn);
        // Then select the file after items are rendered
        setTimeout(function() {
            var fileBtn = document.querySelector('.vault-file-item[data-filepath="' + type + '/' + filename + '"]');
            if (fileBtn) selectVaultFile(type, filename, fileBtn);
        }, 50);
    };

    window.closeMemoryDetail = function() {
        clearVaultContent();
    };

    window.filterVault = function(type) {
        var typeBtn = document.querySelector('.vault-tree-item[data-type="' + type + '"]');
        if (typeBtn) selectVaultType(type, typeBtn);
    };

    window.debouncedSearch = function() {
        clearTimeout(vaultDebounceTimer);
        var query = document.getElementById('vaultSearch').value.trim();
        vaultDebounceTimer = setTimeout(function() {
            if (vaultSelectedType) {
                renderVaultItems(vaultSelectedType, query || null);
            }
        }, 300);
    };

    //  PROFILE PAGE 

    async function checkAuthStatus() {
        try {
            var res = await fetch('/api/auth/status');
            var data = await res.json();
            var statusEl = document.getElementById('authStatus');
            var actionRow = document.getElementById('authActionRow');

            if (data.authenticated) {
                statusEl.textContent = '';
                var connBadge = document.createElement('span');
                connBadge.className = 'auth-badge connected';
                connBadge.textContent = 'Connected';
                statusEl.appendChild(connBadge);
                actionRow.style.display = 'none';
            } else if (data.credentials_exist) {
                statusEl.textContent = '';
                var discBadge = document.createElement('span');
                discBadge.className = 'auth-badge disconnected';
                discBadge.textContent = 'Not connected';
                statusEl.appendChild(discBadge);
                actionRow.style.display = 'flex';
            } else {
                statusEl.textContent = '';
                var noBadge = document.createElement('span');
                noBadge.className = 'auth-badge disconnected';
                noBadge.textContent = 'No credentials';
                statusEl.appendChild(noBadge);
                actionRow.style.display = 'none';
                var card = document.getElementById('authCard');
                var existingHelp = card.querySelector('.auth-help-msg');
                if (!existingHelp) {
                    var helpP = document.createElement('p');
                    helpP.className = 'empty-state auth-help-msg';
                    helpP.style.marginTop = '12px';
                    helpP.textContent = 'Place credentials.json in the project root to enable Gmail.';
                    card.appendChild(helpP);
                }
            }
        } catch (e) {
            document.getElementById('authStatus').textContent = 'Error checking status';
        }
    }

    //  LOGIN / LOGOUT 

    window.loginWithGoogle = async function() {
        var btn = document.getElementById('loginGoogleBtn');
        btn.disabled = true;
        var origText = btn.textContent;
        btn.textContent = 'Connecting...';
        try {
            var res = await fetch('/api/auth/google', { method: 'POST' });
            if (!res.ok) throw new Error('Auth failed');
            var data = await res.json();
            if (data.status === 'success' || data.status === 'already_authenticated') {
                showMainApp();
                loadUserInfo();
            }
        } catch (e) {
            var footnote = document.querySelector('.login-footnote');
            if (footnote) {
                footnote.textContent = 'Connection failed. Make sure credentials.json exists.';
                footnote.style.color = 'var(--accent-warm)';
            }
        } finally {
            btn.disabled = false;
            btn.textContent = origText;
        }
    };

    window.logoutAccount = async function() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
            showLoginPage();
        } catch (e) {
            console.error('Logout failed:', e);
        }
    };

    window.connectGmail = async function() {
        var btn = document.getElementById('connectBtn');
        btn.disabled = true;
        btn.textContent = 'Connecting...';

        try {
            var res = await fetch('/api/auth/google', { method: 'POST' });
            if (!res.ok) {
                var errData;
                try { errData = await res.json(); } catch(ex) { errData = {}; }
                throw new Error(errData.detail || 'Connection failed with status ' + res.status);
            }
            var data = await res.json();
            if (data.status === 'success' || data.status === 'already_authenticated') {
                checkAuthStatus();
            }
        } catch (e) {
            var card = document.getElementById('authCard');
            var existingErr = card.querySelector('.auth-error-msg');
            if (existingErr) existingErr.remove();
            var errP = document.createElement('p');
            errP.className = 'empty-state auth-error-msg';
            errP.style.marginTop = '12px';
            errP.style.color = 'var(--accent-warm)';
            errP.textContent = 'Gmail connection failed. Check the server console.';
            card.appendChild(errP);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Connect Gmail';
        }
    };

    window.startBuild = function() {
        var days = document.getElementById('buildDays').value;
        var max = document.getElementById('buildMax').value;
        var query = document.getElementById('buildQuery').value;
        var btn = document.getElementById('buildBtn');
        var progress = document.getElementById('buildProgress');
        var message = document.getElementById('progressMessage');
        var stepEl = document.getElementById('progressStep');

        btn.disabled = true;
        progress.style.display = 'flex';
        progress.classList.remove('done', 'error');
        message.textContent = 'Starting pipeline...';
        message.style.color = '';
        if (stepEl) stepEl.textContent = '';

        var url = '/api/stream/build?days_back=' + encodeURIComponent(days) +
                  '&max_emails=' + encodeURIComponent(max) +
                  '&gmail_query=' + encodeURIComponent(query);
        var source = new EventSource(url);

        var stageOrder = ['fetching', 'email_reader', 'memory_writer'];
        var totalSteps = stageOrder.length;

        source.onmessage = function(e) {
            var event = JSON.parse(e.data);

            if (event.message) {
                message.textContent = event.message;
            }

            // Update step ratio
            var stageKey = event.stage || '';
            var stageIdx = stageOrder.indexOf(stageKey);
            if (stageIdx >= 0 && stepEl) {
                stepEl.textContent = (stageIdx + 1) + '/' + totalSteps;
            }

            if (event.stage === 'complete') {
                source.close();
                btn.disabled = false;
                progress.classList.add('done');
                var total = (event.stats && event.stats.total) || 0;
                message.textContent = 'Done! ' + total + ' memories processed.';
                if (stepEl) stepEl.textContent = totalSteps + '/' + totalSteps;
                loadProfileStats();
            }

            if (event.stage === 'error') {
                source.close();
                btn.disabled = false;
                progress.classList.add('error');
                message.textContent = 'Error: ' + (event.message || 'Pipeline failed');
                message.style.color = 'var(--accent-warm)';
            }
        };

        source.onerror = function() {
            source.close();
            btn.disabled = false;
            progress.classList.add('error');
            message.textContent = 'Connection lost. Check server logs.';
            message.style.color = 'var(--accent-warm)';
        };
    };

    async function loadProfileStats() {
        try {
            var res = await fetch('/api/stats');
            var stats = await res.json();
            var container = document.getElementById('profileStats');
            container.textContent = '';

            if (stats.total === 0) {
                var emptyP = document.createElement('p');
                emptyP.className = 'empty-state';
                emptyP.textContent = 'No memories yet.';
                container.appendChild(emptyP);
                return;
            }

            // Total row
            var totalRow = document.createElement('div');
            totalRow.className = 'card-row';
            var totalLabel = document.createElement('span');
            totalLabel.className = 'card-row-label';
            totalLabel.textContent = 'Total memories';
            var totalValue = document.createElement('span');
            totalValue.className = 'card-row-value';
            totalValue.style.fontFamily = 'var(--font-mono)';
            totalValue.style.fontWeight = '500';
            totalValue.textContent = stats.total;
            totalRow.appendChild(totalLabel);
            totalRow.appendChild(totalValue);
            container.appendChild(totalRow);

            // Type rows
            var byType = stats.by_type || {};
            Object.keys(byType).forEach(function(typeName) {
                var typeRow = document.createElement('div');
                typeRow.className = 'card-row';

                var typeLabel = document.createElement('span');
                typeLabel.className = 'card-row-label';
                var typeBadge = document.createElement('span');
                typeBadge.className = 'type-badge ' + typeName;
                typeBadge.textContent = typeName;
                typeLabel.appendChild(typeBadge);

                var typeValue = document.createElement('span');
                typeValue.className = 'card-row-value';
                typeValue.style.fontFamily = 'var(--font-mono)';
                typeValue.textContent = byType[typeName];

                typeRow.appendChild(typeLabel);
                typeRow.appendChild(typeValue);
                container.appendChild(typeRow);
            });
        } catch (e) {
            var container2 = document.getElementById('profileStats');
            container2.textContent = '';
            var errP = document.createElement('p');
            errP.className = 'empty-state';
            errP.textContent = 'Could not load stats.';
            container2.appendChild(errP);
        }
    }

    //  KEYBOARD SHORTCUTS 
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeMemoryDetail();
    });

    //  WINDOW RESIZE 
    window.addEventListener('resize', function() {
        updatePanelOpenBtnVisibility();
    });

    //  BOOT 
    init();

})();
</script>

</body>
</html>